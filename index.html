<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ribbon XML Builder (Sortable)</title>
    <style>
        :root { --primary: #217346; --bg: #f3f2f1; --border: #c8c6c4; --blue: #0078d4; --red: #d93025; --gray: #666; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; 
            display: flex; gap: 15px; height: 100vh; box-sizing: border-box; overflow: hidden; 
        }
        
        /* LAYOUT */
        .editor-panel { 
            flex: 1; background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; border: 1px solid var(--border);
        }
        .code-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; height: 100%; }
        
        textarea { 
            flex: 1; width: 100%; font-family: 'Consolas', monospace; padding: 15px; 
            border: 1px solid #333; border-radius: 8px; resize: none; 
            background: #1e1e1e; color: #dcdcdc; font-size: 14px; line-height: 1.5; box-sizing: border-box;
        }
        
        /* UI ELEMENTS */
        .group-block { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; background: #fff; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.3s; }
        .group-block:hover { background: #fafafa; }
        
        .btn-item { 
            display: grid; grid-template-columns: 30px 1fr 1.2fr 1.6fr 1fr 0.8fr 30px; gap: 5px; 
            margin-bottom: 5px; align-items: center; padding: 6px; background: #f8f9fa; 
            border: 1px solid #eee; border-radius: 4px; 
        }
        .btn-item:hover { border-color: #ccc; }
        
        /* INPUTS & BUTTONS */
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.9em; }
        input:focus { border-color: var(--blue); outline: none; }

        button { cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; white-space: nowrap; transition: 0.2s; }
        button:hover { opacity: 0.9; }

        .btn-add-group { background: var(--primary); color: white; margin-top: 10px; width: 100%; padding: 10px; }
        .btn-add-btn { background: #fff; border: 1px dashed var(--blue); color: var(--blue); font-size: 0.85em; margin-top: 5px; width: 100%; }
        .btn-del { background: var(--red); color: white; padding: 6px; font-size: 0.8em; min-width: 30px;}
        
        /* MOVE CONTROLS */
        .move-controls { display: flex; flex-direction: column; gap: 2px; }
        .btn-move { padding: 0; width: 20px; height: 14px; font-size: 10px; line-height: 10px; background: #e1dfdd; color: #333; border: 1px solid #ccc; }
        .btn-move:hover { background: var(--blue); color: white; border-color: var(--blue); }

        .btn-action-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .btn-gen { background: var(--blue); color: white; flex: 2; padding: 12px; font-size: 1.1em; }
        .btn-reverse { background: #d83b01; color: white; flex: 1; padding: 12px; font-size: 1.1em; }
        .btn-reset { background: #666; color: white; flex: 0.5; padding: 12px; font-size: 1.1em; }

        label { font-size: 0.75em; color: #666; font-weight: bold; margin-bottom: 4px; display: block; text-transform: uppercase; }
        h2 { margin: 0; color: #333; font-size: 1.5em; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .link-tool { text-decoration: none; background: #fff; padding: 6px 12px; border-radius: 20px; color: #333; font-size: 0.85em; font-weight: bold; border: 1px solid #ccc; display: flex; align-items: center; gap: 5px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="editor-panel" id="mainEditor">
        <div class="header-row">
            <h2>Ribbon Config</h2>
            <a href="https://bert-toolkit.com/imagemso-list.html" target="_blank" class="link-tool">üîç Tra c·ª©u Icon</a>
        </div>

        <div style="margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #e6f2ea; padding: 15px; border-radius: 8px; border: 1px solid #cce5d5;">
            <div><label>Tab ID</label><input type="text" id="tabId" value="tabNNTools" style="font-weight:bold;"></div>
            <div><label>Tab Label</label><input type="text" id="tabLabel" value="NNTools" style="font-weight:bold;"></div>
        </div>

        <div id="groupsContainer"></div>

        <button class="btn-add-group" onclick="addGroup()">+ TH√äM GROUP M·ªöI</button>
    </div>

    <div class="code-panel">
        <div class="btn-action-row">
            <button class="btn-gen" onclick="generateXML()">‚¨áÔ∏è XU·∫§T CODE XML</button>
            <button class="btn-reverse" onclick="importXML()">‚¨ÜÔ∏è D·ªäCH NG∆Ø·ª¢C (IMPORT)</button>
            <button class="btn-reset" onclick="resetData()" title="X√≥a h·∫øt d·ªØ li·ªáu v√† l√†m m·ªõi">üóë RESET</button>
        </div>
        <textarea id="xmlContent" placeholder="Paste m√£ XML v√†o ƒë√¢y ƒë·ªÉ d·ªãch ng∆∞·ª£c, ho·∫∑c b·∫•m Xu·∫•t Code ƒë·ªÉ l·∫•y m√£..."></textarea>
    </div>

<script>
    const STORAGE_KEY = 'ribbon_tool_data_v3'; // ƒê·ªïi key m·ªõi ƒë·ªÉ tr√°nh xung ƒë·ªôt

    // --- 1. TI·ªÜN √çCH CHU·ªñI ---
    function convertToId(str, prefix) {
        if (!str) return "";
        str = str.toLowerCase()
            .replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a")
            .replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e")
            .replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i")
            .replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o")
            .replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u")
            .replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y").replace(/ƒë/g, "d")
            .replace(/[^a-z0-9\s]/g, "").replace(/(?:^|\s)\S/g, a => a.toUpperCase()).replace(/\s+/g, "");
        return prefix + str;
    }

    function onLabelChange(input, type) {
        const parent = input.closest(type === 'btn' ? '.btn-item' : '.group-block');
        const idInput = parent.querySelector(type === 'btn' ? '.b-id' : '.g-id');
        const prefix = type === 'btn' ? 'btn' : 'grp';
        if(idInput.value === "" || idInput.value.startsWith(prefix)) {
             idInput.value = convertToId(input.value, prefix);
        }
        saveData();
    }

    // --- 2. LOGIC DI CHUY·ªÇN (M·ªöI) ---
    function moveUp(btn, type) {
        const item = btn.closest(type === 'grp' ? '.group-block' : '.btn-item');
        const prevItem = item.previousElementSibling;
        // Ki·ªÉm tra xem ph·∫ßn t·ª≠ ph√≠a tr∆∞·ªõc c√≥ ph·∫£i l√† item c√πng lo·∫°i kh√¥ng
        if (prevItem && prevItem.classList.contains(type === 'grp' ? 'group-block' : 'btn-item')) {
            item.parentNode.insertBefore(item, prevItem);
            saveData();
        }
    }

    function moveDown(btn, type) {
        const item = btn.closest(type === 'grp' ? '.group-block' : '.btn-item');
        const nextItem = item.nextElementSibling;
        if (nextItem && nextItem.classList.contains(type === 'grp' ? 'group-block' : 'btn-item')) {
            item.parentNode.insertBefore(nextItem, item);
            saveData();
        }
    }

    // --- 3. RENDER GIAO DI·ªÜN ---
    const container = document.getElementById('groupsContainer');

    function renderBtnHTML(btnData = {}) {
        let imgType = 'imageMso';
        let imgVal = btnData.imageMso || '';
        if (btnData.image) { imgType = 'image'; imgVal = btnData.image; }
        const isCustom = imgType === 'image';

        return `
            <div class="btn-item">
                <div class="move-controls">
                    <button class="btn-move" onclick="moveUp(this, 'btn')" title="L√™n">‚ñ≤</button>
                    <button class="btn-move" onclick="moveDown(this, 'btn')" title="Xu·ªëng">‚ñº</button>
                </div>

                <div><input type="text" placeholder="ID" class="b-id" value="${btnData.id || ''}" oninput="saveData()"></div>
                <div><input type="text" placeholder="Label" class="b-label" value="${btnData.label || ''}" oninput="onLabelChange(this, 'btn')"></div>
                <div style="display:flex; gap:2px;">
                    <select class="b-img-type" style="width: 65px; font-size:0.8em;" onchange="this.nextElementSibling.placeholder = this.value === 'image' ? 'File name' : 'Mso Name'; saveData();">
                        <option value="imageMso" ${!isCustom ? 'selected' : ''}>Mso</option>
                        <option value="image" ${isCustom ? 'selected' : ''}>Custom</option>
                    </select>
                    <input type="text" placeholder="${isCustom ? 'File name' : 'Mso Name'}" class="b-img-val" value="${imgVal}" oninput="saveData()">
                </div>
                <div><input type="text" placeholder="Sub Name" class="b-act" value="${btnData.onAction || ''}" oninput="saveData()"></div>
                <div>
                    <select class="b-size" onchange="saveData()">
                        <option value="normal" ${btnData.size !== 'large' ? 'selected' : ''}>Normal</option>
                        <option value="large" ${btnData.size === 'large' ? 'selected' : ''}>Large</option>
                    </select>
                </div>
                <button class="btn-del" onclick="this.parentElement.remove(); saveData();" title="X√≥a n√∫t">üóë</button>
            </div>
        `;
    }

    function renderGroupHTML(groupData = {}) {
        let btnsHTML = '';
        if(groupData.buttons && groupData.buttons.length > 0) {
            groupData.buttons.forEach(b => btnsHTML += renderBtnHTML(b));
        }
        const div = document.createElement('div');
        div.className = 'group-block';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <div style="display:flex; gap:10px; align-items:center; width: 100%;">
                    <div class="move-controls">
                        <button class="btn-move" onclick="moveUp(this, 'grp')" title="L√™n">‚ñ≤</button>
                        <button class="btn-move" onclick="moveDown(this, 'grp')" title="Xu·ªëng">‚ñº</button>
                    </div>
                    <div style="width:35%"><label>Group ID</label><input type="text" class="g-id" value="${groupData.id || ''}" oninput="saveData()"></div>
                    <div style="width:35%"><label>Group Label</label><input type="text" class="g-label" value="${groupData.label || ''}" oninput="onLabelChange(this, 'grp')"></div>
                    <button class="btn-del" style="height:35px; margin-left:auto;" onclick="this.closest('.group-block').remove(); saveData();">X√≥a Group</button>
                </div>
            </div>
            
            <div class="btns-container">
                <div style="display:grid; grid-template-columns: 30px 1fr 1.2fr 1.6fr 1fr 0.8fr 30px; gap:5px; font-size:0.75em; font-weight:bold; color:#666; margin-bottom:5px; padding-left:5px;">
                    <span>Pos</span><span>ID</span><span>LABEL</span><span>ICON</span><span>ON ACTION</span><span>SIZE</span><span></span>
                </div>
                ${btnsHTML}
            </div>
            <button class="btn-add-btn" onclick="addButtonToGroup(this)">+ Th√™m N√∫t B·∫•m</button>
        `;
        return div;
    }

    function addGroup() {
        container.appendChild(renderGroupHTML({}));
        const editor = document.querySelector('.editor-panel');
        editor.scrollTop = editor.scrollHeight;
        saveData();
    }

    function addButtonToGroup(btnElement) {
        const btnsContainer = btnElement.previousElementSibling;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderBtnHTML({});
        btnsContainer.appendChild(tempDiv.firstElementChild);
        saveData();
    }

    // --- 4. LOGIC L∆ØU TR·ªÆ & IMPORT/EXPORT ---
    function saveData() {
        const data = {
            tabId: document.getElementById('tabId').value,
            tabLabel: document.getElementById('tabLabel').value,
            groups: []
        };

        document.querySelectorAll('.group-block').forEach(g => {
            const groupObj = {
                id: g.querySelector('.g-id').value,
                label: g.querySelector('.g-label').value,
                buttons: []
            };

            g.querySelectorAll('.btn-item').forEach(b => {
                // Ki·ªÉm tra null check cho ch·∫Øc ch·∫Øn
                const imgTypeEl = b.querySelector('.b-img-type');
                if(!imgTypeEl) return; // B·ªè qua n·∫øu l√† header

                const bImgType = imgTypeEl.value;
                const bImgVal = b.querySelector('.b-img-val').value;
                
                groupObj.buttons.push({
                    id: b.querySelector('.b-id').value,
                    label: b.querySelector('.b-label').value,
                    onAction: b.querySelector('.b-act').value,
                    size: b.querySelector('.b-size').value,
                    imageMso: bImgType === 'imageMso' ? bImgVal : null,
                    image: bImgType === 'image' ? bImgVal : null
                });
            });
            data.groups.push(groupObj);
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
        const json = localStorage.getItem(STORAGE_KEY);
        if (!json) {
            container.appendChild(renderGroupHTML({id: 'grpMau', label: 'Group M·∫´u', buttons: [{id: 'btnMau', label: 'N√∫t M·∫´u', size: 'large', imageMso: 'HappyFace'}]}));
            return;
        }
        try {
            const data = JSON.parse(json);
            document.getElementById('tabId').value = data.tabId || 'tabCustom';
            document.getElementById('tabLabel').value = data.tabLabel || 'My Tools';
            container.innerHTML = '';
            if (data.groups) {
                data.groups.forEach(g => container.appendChild(renderGroupHTML(g)));
            }
        } catch (e) { console.error(e); }
    }

    function resetData() {
        if(confirm("X√ìA H·∫æT v√† l√†m l·∫°i t·ª´ ƒë·∫ßu?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function generateXML() {
        saveData();
        const tabId = document.getElementById('tabId').value || 'tabCustom';
        const tabLabel = document.getElementById('tabLabel').value || 'My Tools';
        
        let xml = `<customUI xmlns="http://schemas.microsoft.com/office/2009/07/customui">\n  <ribbon>\n    <tabs>\n`;
        xml += `      <tab id="${tabId}" label="${tabLabel}" insertBeforeMso="TabHome">\n`;

        document.querySelectorAll('.group-block').forEach(g => {
            const gId = g.querySelector('.g-id').value;
            if(!gId) return;
            xml += `        <group id="${gId}" label="${g.querySelector('.g-label').value}">\n`;
            
            g.querySelectorAll('.btn-item').forEach(b => {
                const bId = b.querySelector('.b-id').value;
                if(!bId) return;
                const bImgType = b.querySelector('.b-img-type').value;
                const bImgVal = b.querySelector('.b-img-val').value;
                let attrStr = ` id="${bId}" label="${b.querySelector('.b-label').value}"`;
                if(bImgVal) attrStr += ` ${bImgType}="${bImgVal}"`;
                if(b.querySelector('.b-size').value === 'large') attrStr += ` size="large"`;
                if(b.querySelector('.b-act').value) attrStr += ` onAction="${b.querySelector('.b-act').value}"`;
                xml += `          <button${attrStr} />\n`;
            });
            xml += `        </group>\n`;
        });
        xml += `      </tab>\n    </tabs>\n  </ribbon>\n</customUI>`;
        document.getElementById('xmlContent').value = xml;
    }

    function importXML() {
        const xmlText = document.getElementById('xmlContent').value.trim();
        if(!xmlText) { alert("Thi·∫øu m√£ XML!"); return; }
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, "text/xml");
            if (doc.querySelector("parsererror")) { alert("XML l·ªói."); return; }

            container.innerHTML = '';
            const tabNode = doc.querySelector('tab');
            if(tabNode) {
                document.getElementById('tabId').value = tabNode.getAttribute('id') || 'tabCustom';
                document.getElementById('tabLabel').value = tabNode.getAttribute('label') || 'My Tools';
            }
            const groups = doc.querySelectorAll('group');
            groups.forEach(gNode => {
                const groupData = {
                    id: gNode.getAttribute('id'), label: gNode.getAttribute('label'), buttons: []
                };
                gNode.querySelectorAll('button').forEach(bNode => {
                    groupData.buttons.push({
                        id: bNode.getAttribute('id'),
                        label: bNode.getAttribute('label'),
                        onAction: bNode.getAttribute('onAction'),
                        size: bNode.getAttribute('size') || 'normal',
                        imageMso: bNode.getAttribute('imageMso'),
                        image: bNode.getAttribute('image')
                    });
                });
                container.appendChild(renderGroupHTML(groupData));
            });
            saveData();
            alert("ƒê√£ nh·∫≠p th√†nh c√¥ng!");
        } catch (e) { alert("L·ªói: " + e.message); }
    }

    document.getElementById('tabId').addEventListener('input', saveData);
    document.getElementById('tabLabel').addEventListener('input', saveData);
    window.onload = loadData;

</script>
</body>
</html>
